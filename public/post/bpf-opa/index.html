<!doctype html><html lang=en><head><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-62096468-4','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content=#0071BD><title>Blog | ByteBuilders</title><link rel=apple-touch-icon sizes=57x57 href=/assets/images/products/bytebuilders/icons/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/assets/images/products/bytebuilders/icons/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/assets/images/products/bytebuilders/icons/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/assets/images/products/bytebuilders/icons/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/assets/images/products/bytebuilders/icons/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/assets/images/products/bytebuilders/icons/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/assets/images/products/bytebuilders/icons/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/assets/images/products/bytebuilders/icons/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/assets/images/products/bytebuilders/icons/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/assets/images/products/bytebuilders/icons/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/assets/images/products/bytebuilders/icons/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/assets/images/products/bytebuilders/icons/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/assets/images/products/bytebuilders/icons/favicon-16x16.png><link rel=manifest href=/assets/images/products/bytebuilders/icons/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/assets/images/products/bytebuilders/icons/ms-icon-144x144.png><link rel=stylesheet href=/assets/css/font-awesome.min.css><link href=https://unpkg.com/aos@2.3.1/dist/aos.css rel=stylesheet><link rel=stylesheet href=/assets/css/bulma.min.css><link rel=stylesheet href=/assets/sass/main.min.css></head><body><header id=header><div class=header-top><div class=container><nav class="navbar customize-navbar" role=navigation aria-label="main navigation"><div class=navbar-brand><a class=navbar-item href=https://byte.builders><img src=/assets/images/products/bytebuilders/bytebuilders.png></a>
<a role=button class="navbar-burger burger" aria-label=menu aria-expanded=false data-target=navbarBasicExample><span aria-hidden=true></span><span aria-hidden=true></span><span aria-hidden=true></span></a></div><div id=navbarBasicExample class=navbar-menu><div class=navbar-end><a href=https://marketplace.byte.builders class=navbar-item>Marketplace</a>
<a href=https://blog.byte.builders class=navbar-item>Blog</a>
<a href=https://appscode.com/about/ class=navbar-item>About Us</a>
<a href=https://appscode.com/contact/ class=navbar-item>Contact</a><div class=navbar-item><div class=buttons><a href=https://byte.builders/user/sign_up class="button is-light is-primary">Sign up</a>
<a href=https://byte.builders/user/login class="button is-primary">Sign in</a></div></div></div></div></nav></div></div></header><section class="blog-heading-area section-padding"><div class="container section"><div class=columns><div class="column has-text-centered"><div class=blog-heading><p data-aos=fade-up class=meta-date><i class="fa fa-calendar" aria-hidden=true></i>17-Nov-2019</p><h1 data-aos=fade-up data-aos-duration=500>Secure Kubernetes using eBPF &amp; Open Policy Agent</h1><p data-aos=fade-up data-aos-duration=600 class=author><span>by </span><a href=/authors/md-tahsin-rahman>Md Tahsin Rahman</a></p></div><figure class=fig-style><img data-aos=fade-up data-aos-duration=600 src=/post/bpf-opa/hero_hube6602640c973b42be4235df66fa2f04_507055_1300x650_fill_q75_box_smart1.jpg alt></a></figure></div></div></div></section><section class=blog-details-area><div class="container section"><div class=columns><div class="column is-2"><div class=sticky-social-menu><div class=social-link-vertical><ul><li><a title=Twitter href="http://twitter.com/share?url=https%3a%2f%2fblog.byte.builders%2fpost%2fbpf-opa%2f&text=Secure%20Kubernetes%20using%20eBPF%20%26amp%3b%20Open%20Policy%20Agent" class=twitter aria-label="share on Twitter"><i class="fa fa-twitter" aria-hidden=true></i></a></li><li><a title=Linkedin href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.byte.builders%2fpost%2fbpf-opa%2f&title=Secure%20Kubernetes%20using%20eBPF%20%26amp%3b%20Open%20Policy%20Agent&summary=Securing%20Kubernetes%20cluster%20is%20a%20multi-faceted%20task.%20Runtime%20security%20is%20one%20aspect%20of%20it.%20It%20ensures%20that%20the%20workloads%20deployed%20in%20the%20cluster%20doesn%26amp%3brsquo%3bt%20do%20any%20malicious%20behaviors.%20For%20runtime%20instrumentation%2c%20we%20wanted%20to%20use%20Extended%20Berkeley%20Packet%20Filter%20%28eBPF%29%2c%20a%20core%20technology%20in%20the%20Linux%20kernel.%0aThere%20are%20already%20many%20tools%20available%20in%20this%20space%2c%20but%20each%20project%20has%20its%20own%20custom%20components.%20We%20want%20to%20use%20a%20set%20of%20common%20set%20of%20tools%20and%20techniques%20for%20binding%20these%20different%20components.&source=LinkedIn" class=linkedin><i class="fa fa-linkedin" aria-hidden=true></i></a></li><li><a title=Facebook href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.byte.builders%2fpost%2fbpf-opa%2f" class=facebook aria-label="share on Facebook"><i class="fa fa-facebook" aria-hidden=true></i></a></li><li><a href="mailto:?subject=Secure%20Kubernetes%20using%20eBPF%20%26amp%3b%20Open%20Policy%20Agent&body=https%3a%2f%2fblog.byte.builders%2fpost%2fbpf-opa%2f"><i class="fa fa-envelope-o" aria-hidden=true></i></a></li></ul></div></div></div><div class="column is-8"><div class=blog-content><p>Securing Kubernetes cluster is a multi-faceted task. Runtime security is one aspect of it. It ensures that the workloads deployed in the cluster doesn&rsquo;t do any malicious behaviors. For runtime instrumentation, we wanted to use Extended Berkeley Packet Filter (eBPF), a core technology in the Linux kernel.</p><p>There are already many tools available in this space, but each project has its own custom components. We want to use a set of common set of tools and techniques for binding these different components.</p><p>For runtime analysis, we already have <a href=http://falco.org/>Falco</a> project. Falco was initially dependent on kernel modules, but now they are using eBPF technology.</p><p>Falco is written in C++, but Kubernetes and its associated libraries are written in Go. Having a tool that is written in Go helps us to be more integrated with kubernetes.</p><p>Falco also has its own custom rule engine. We wanted to replace Falco&rsquo;s rule engine with with <a href=https://www.openpolicyagent.org/>Open Policy Agent (OPA)</a>, an open-source, general purpose policy engine.</p><h2 id=architecture>Architecture</h2><p>The central component of this project is the Open Policy Agent (OPA) and Extended Berkeley Packet Filter (eBPF). eBPF is a modern and powerful technology in the Linux kernel. eBPF allows a user to attach programs to certain parts of the Linux kernel. When the code path is traversed, the attached eBPF programs are executed.</p><p>The open policy agent (OPA) is an open-source, general-purpose policy engine. OPA provides a high-level declarative language called Rego. Using rego, one can write policies. The application queries OPA and supplies JSON data as input for any policy violations for the given input.</p><p>Any application running in a Linux system communicates with the kernel with the system call interface. Everything the application is doing is done through the system call interface. So if we can monitor what system calls the application is doing, we can detect if the application is doing any kind of malicious activity.</p><p>To instrument on the system call interface, we&rsquo;re leveraging eBPF technology. We&rsquo;re attaching eBPF programs to the system call interface and extracting the parameters by which the system call is invoked. Then this information is passed to the kernel perf ring buffer. Our userspace program retrieves the information from the perf ring buffer, parses the raw syscall arguments and then finally queries to the OPA server for rule violations. Users can also write their own rules using rego and supply them to the OPA server.</p><p><img src=arch.svg alt=a>
Fig: Diagram showing the major components of bpf-opa-demo</p><h2 id=usage>Usage</h2><blockquote><p>Make sure that you&rsquo;re running a linux machine with kernel version <code>4.17</code> or higher. We&rsquo;re attaching eBPF programs to <code>raw_tracepoints</code>, and this feature is available from linux kernel <code>4.17</code>. For more information, you can see <a href=https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md>here</a>.</p></blockquote><p>Download <code>Open Policy Agent</code> from <a href=https://github.com/open-policy-agent/opa/releases>github release page</a>. Start the OPA server</p><pre><code class=language-bash>opa run -s
</code></pre><p>Download <code>bpf-opa-demo</code> binary from <a href=https://github.com/kubeshield/bpf-opa-demo/releases>github release page</a>. Run the binary with root permissions.</p><pre><code class=language-bash>sudo ./bpf-opa-demo
</code></pre><p>You can use the open policy agent&rsquo;s <a href=https://www.openpolicyagent.org/docs/latest/rest-api/>rest-API</a> to update the default rules and add your own rules.</p><p>When you run something that violates the rules, the program will print to the stdout the input with which it is queried</p><pre><code class=language-json>{
  &quot;modify_shell_configuration_file&quot;: {
    &quot;event&quot;: {
      &quot;len&quot;: 87,
      &quot;name&quot;: &quot;openat&quot;,
      &quot;nparams&quot;: 6,
      &quot;params&quot;: {
        &quot;dev&quot;: 2049,
        &quot;dirfd&quot;: 18446744073709552000,
        &quot;fd&quot;: 3,
        &quot;flags&quot;: 14,
        &quot;mode&quot;: 438,
        &quot;name&quot;: &quot;/home/tahsin/.bashrc&quot;
      },
      &quot;tid&quot;: 30828,
      &quot;ts&quot;: 27562555577941,
      &quot;type&quot;: 307
    },
    &quot;process&quot;: {
      &quot;args&quot;: [
        &quot;/home/tahsin/.bashrc&quot;
      ],
      &quot;cgroup&quot;: [
        &quot;cpuset=/&quot;,
        &quot;cpu=/user.slice&quot;,
        &quot;cpuacct=/user.slice&quot;,
        &quot;io=/user.slice&quot;,
        &quot;memory=/user.slice/user-1001.slice/session-2.scope&quot;
      ],
      &quot;command&quot;: &quot;nano&quot;,
      &quot;executable&quot;: &quot;nano&quot;,
      &quot;name&quot;: &quot;&quot;,
      &quot;parent&quot;: {
        &quot;args&quot;: [],
        &quot;cgroup&quot;: [
          &quot;&quot;
        ],
        &quot;command&quot;: &quot;/usr/bin/fish&quot;,
        &quot;executable&quot;: &quot;/usr/bin/fish&quot;,
        &quot;name&quot;: &quot;fish&quot;,
        &quot;parent&quot;: null,
        &quot;pid&quot;: 30573,
        &quot;ppid&quot;: 0
      },
      &quot;pid&quot;: 30828,
      &quot;ppid&quot;: 30573
    }
  }
}
</code></pre><p>This indicates that the process <code>nano</code> did the system call <code>openat</code> to edit the file <code>.bashrc</code>. Here <code>process.cgroup</code> is empty as we&rsquo;re running this from our host machine. If we run time same thing from the container, we get the following output</p><pre><code class=language-json>{
  &quot;read_shell_configuration_file&quot;: {
    &quot;event&quot;: {
      &quot;len&quot;: 80,
      &quot;name&quot;: &quot;openat&quot;,
      &quot;nparams&quot;: 6,
      &quot;params&quot;: {
        &quot;dev&quot;: 102,
        &quot;dirfd&quot;: 18446744073709552000,
        &quot;fd&quot;: 3,
        &quot;flags&quot;: 1,
        &quot;mode&quot;: 0,
        &quot;name&quot;: &quot;/root/.bashrc&quot;
      },
      &quot;tid&quot;: 384,
      &quot;ts&quot;: 29654919403736,
      &quot;type&quot;: 307
    },
    &quot;process&quot;: {
      &quot;args&quot;: [
        &quot;/root/.bashrc&quot;
      ],
      &quot;cgroup&quot;: [
        &quot;cpuset=/docker/41e5c07cc31073cfcad80176bf5195d04d4511cfdaba0205ac149112579a03c9&quot;,
        &quot;cpu=/docker/41e5c07cc31073cfcad80176bf5195d04d4511cfdaba0205ac149112579a03c9&quot;,
        &quot;cpuacct=/docker/41e5c07cc31073cfcad80176bf5195d04d4511cfdaba0205ac149112579a03c9&quot;,
        &quot;io=/docker/41e5c07cc31073cfcad80176bf5195d04d4511cfdaba0205ac149112579a03c9&quot;,
        &quot;memory=/docker/41e5c07cc31073cfcad80176bf5195d04d4511cfdaba0205ac149112579a03c9&quot;
      ],
      &quot;command&quot;: &quot;cat&quot;,
      &quot;executable&quot;: &quot;cat&quot;,
      &quot;name&quot;: &quot;&quot;,
      &quot;parent&quot;: {
        &quot;args&quot;: null,
        &quot;cgroup&quot;: null,
        &quot;command&quot;: &quot;&quot;,
        &quot;executable&quot;: &quot;&quot;,
        &quot;name&quot;: &quot;&quot;,
        &quot;parent&quot;: null,
        &quot;pid&quot;: 0,
        &quot;ppid&quot;: 0
      },
      &quot;pid&quot;: 384,
      &quot;ppid&quot;: 32735
    }
  }
}
</code></pre><p>You can see that the <code>process.cgroup</code> now has the docker container ID from which the command was run on.</p><h2 id=findings>Findings</h2><p>When doing this project, we found some limitations of rego.</p><ul><li><p>You can not write complex rules inside a single rule body. When evaluating rule bodies, OPA searches for variable bindings that make all of the expressions true. There may be multiple sets of bindings that make the rule body true. The rule body can be understood intuitively as: <code>expression-1 AND expression-2 AND ... AND expression-N</code>. In order to use <code>OR</code>, you have to define a rule multiple times. An incrementally defined rule can be intuitively understood as <code>&lt;rule-1&gt; OR &lt;rule-2&gt; OR ... OR &lt;rule-N&gt;</code>. So writing complex rules that involve multiple nested <code>AND</code> and <code>OR</code> expressions are very painful. For example, this following rule checks if <code>ncat</code> process was run with some arguments, so we had to write rules for each argument separately.</p><pre><code>Netcat_Remote_Code_Execution = input {
nc_process
}
Netcat_Remote_Code_Execution = input {
ncat_process
}
</code></pre><pre><code>ncat_arg_contains_exe {
 contains(input.process.args[_], &quot;--sh-exec&quot;)
}
ncat_arg_contains_exe {
 contains(input.process.args[_], &quot;--exec&quot;)
}
ncat_arg_contains_exe {
 contains(input.process.args[_], &quot;-e &quot;)
}
ncat_arg_contains_exe {
 contains(input.process.args[_], &quot;-c &quot;)
}
ncat_arg_contains_exe {
 contains(input.process.args[_], &quot;--lua-exec&quot;)
}
</code></pre></li><li><p>You can not do bitwise operations in rego. For example, to check if <code>O_RDONLY</code> flag set on <code>open</code> syscalls, we had to do the following</p><pre><code>O_RDONLY := 1

is_open_read {
round((input.event.params.flags-0.1) / O_RDONLY) % 2 &gt; 0
}
</code></pre></li><li><p>Rego doesn&rsquo;t support any kind of loops, if else blocks etc. We can write more complex rules if it has support for these.</p></li></ul><p>You can find the project on <a href=https://github.com/kubeshield/bpf-opa-demo>GitHub</a>.</p><p>If you have read all the way to the end, I want to thank you. If you have any questions and want to know more, you can reach us via <a href=mailto:kubeshield-dev@appscode.com>Email</a>.</p><div class=tags><a href=/tags/kubernetes class=tag>kubernetes</a>
<a href=/tags/security class=tag>security</a>
<a href=/tags/bpa class=tag>bpa</a>
<a href=/tags/falco class=tag>falco</a>
<a href=/tags/opa class=tag>opa</a>
<a href=/tags/open%20policy%20agent class=tag>open policy agent</a></div></div></div></div></div></section><section class="cta-area section-padding"><div class="container section"><div class=columns><div class="column is-5 has-text-left"><div class="section-title is-dark-bg" data-aos=fade-up><h2>Get Up and Running Quickly</h2><p>Deploy, manage, upgrade Kubernetes on any cloud and automate deployment, scaling, and management of containerized applications.</p></div><div class="cta-buttons buttons" data-aos=fade-up data-aos-duration=600><a href=https://byte.builders/user/sign_up class="button is-primary is-large">Get started free</a>
<a href=https://appscode.com/meet-expert/ class="button is-large is-white-hoverable">Get a Demo</a></div></div><div class="column is-4 is-offset-3"><div class="right-sidebar style-1"><div class=right-sidebar-inner><div class=single-sidebar-item data-aos=fade-left><h5>Want to host dedicated setup? We got you.</h5><a href=https://appscode.com/contact/ class=inline-button>Contact us</a></div><div class=single-sidebar-item data-aos=fade-left data-aos-duration=500><h5>Need Support SLA for AppsCode OSS projects?</h5><a href=https://appscode.com/pricing/ class=inline-button>Purchase our commercial support package</a></div><div class=single-sidebar-item data-aos=fade-left data-aos-duration=700><h5>Interested in Professional Services & Training?</h5><a href=https://appscode.com/consulting/ class=inline-button>Explore our services</a></div></div></div></div></div></div></section><footer class=footer-area><div class=footer-top><div class="container section"><div class="columns is-mobile is-multiline" data-aos=fade-up><div class="column is-full-mobile is-one-third-desktop is-one-third-widescreen is-one-third-tablet"><div class=single-footer-widget><div class=footer-logo><a href=https://appscode.com><img src=/assets/images/products/appscode/appscode.png alt=AppsCode class=img></a></div><div class=subscription-form><form action="https://appscode.us17.list-manage.com/subscribe/post?u=feb2bf31969a951e7449048a3&amp;id=82fb19acb9" method=post id=mc-embedded-subscribe-form name=mc-embedded-subscribe-form class=navbar-form target=_blank rel=noopener novalidate role=email><h4>Subscribe to Our Newsletter</h4><p class=spam-message>No spam, we promise. Your mail address is secure</p><div class="field has-addons"><div class=control><input class=input name=EMAIL id=mce-EMAIL type=email placeholder="Your work email address" required>
<button id=mc-embedded-subscribe type=submit name=subscribe class=subscription-button>
<i class="fa fa-paper-plane-o" aria-hidden=true></i></button></div></div></form></div><div class=contact-information><h4>Have any Inquiry?</h4><ul class=all-contact-info><li><a href=callto:&#43;1%28650%29241-8486><span><i class="fa fa-phone" aria-hidden=true></i></span>&#43;1(650)241-8486</a></li><li><a href=mailto:support@appscode.com><span><i class="fa fa-envelope-o" aria-hidden=true></i></span>support@appscode.com</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=400><div class=single-footer-widget><div class=footer-menu><h4>Products</h4><ul class=footer-link><li><a href=https://kubedb.com>KubeDB</a></li><li><a href=https://appscode.com/products/stash/>Stash</a></li><li><a href=https://kubevault.com>KubeVault</a></li><li><a href=https://appscode.com/products/voyager/>Voyager</a></li><li><a href=https://appscode.com/products/guard/>Guard</a></li><li><a href=https://pharmer.io>Pharmer</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=500><div class=single-footer-widget><div class=footer-menu><h4>Services</h4><ul class=footer-link><li><a href=https://appscode.com/consulting/>Consulting</a></li><li><a href=https://appscode.com/training/>Training</a></li><li><a href=https://appscode.com/support/>Support</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=600><div class=single-footer-widget><div class=footer-menu><h4>Company</h4><ul class=footer-link><li><a href=https://appscode.com/about/>About Us</a></li><li><a href=https://blog.byte.builders>Blog</a></li><li><a href=https://appscode.com/contact/>Contact Us</a></li></ul></div></div></div><div class="column is-half-mobile" data-aos=fade-up data-aos-duration=700><div class=single-footer-widget><div class=footer-menu><h4>Legal</h4><ul class=footer-link><li><a href=https://appscode.com/legal/tos/>Terms of Sevice</a></li><li><a href=https://appscode.com/legal/privacy-policy/>Privacy Policy</a></li><li><a href=https://appscode.com/legal/security/>Security</a></li><li><a href=https://appscode.com/legal/sla/>Service Level Agreement</a></li></ul></div></div></div></div></div></div><div class=footer-bottom><div class="container section"><div class=columns><div class="column is-4"><p>© 2020 AppsCode Inc. All rights reserved.</p></div><div class="column is-4 has-text-centered-desktop has-text-left-touch"><div class=footer-inline-link><a href=https://appscode.com/legal/privacy-policy/>Privacy Policy</a>
<a href=https://appscode.com/legal/tos/>Terms of Service</a></div></div><div class="column is-4 has-text-right-desktop has-text-left-touch"><div class=social-link-inline><ul><li><a href=https://twitter.com/AppsCodeHQ><i class="fa fa-twitter" aria-hidden=true></i></a></li><li><a href=https://www.facebook.com/appscode><i class="fa fa-facebook" aria-hidden=true></i></a></li><li><a href=https://www.youtube.com/c/AppsCodeInc><i class="fa fa-youtube" aria-hidden=true></i></a></li></ul></div></div></div></div></div></footer><button class=go-to-top id=goTop>
<i class="fa fa-angle-up" aria-hidden=true></i></button>
<script src=https://unpkg.com/aos@2.3.1/dist/aos.js></script><script src=https://unpkg.com/downloadjs@1.4.7/download.min.js></script><script src=https://unpkg.com/clipboard@2/dist/clipboard.min.js></script><script src=/assets/js/main.js></script></body></html>