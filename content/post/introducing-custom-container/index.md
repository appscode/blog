---
title: Add custom containers to KubeDB managed Statefulset
date: 2022-06-23
weight: 25
authors:
- Raihan Khan
  tags:
- kubeDB
- container
- MySQL
- Filebeat
- StatefulSet
- MySQLOpsRequest
---

# Add custom containers to KubeDB managed Statefulset

Let's assume you have a KubeDB managed MySQL cluster deployed in your Kubernetes environment, and you want to use [filebeat](https://www.elastic.co/beats/filebeat) to retrieve database logs from it. You can append filebeat container in your database pods which will fetch the logs from the default DB container. Now, Custom containers can be added to operator-generated [StatefulSets](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset) in KubeDB. Here's a quick demonstration on how to accomplish it.

We are going to deploy a sample MySQL cluster in demo namespace using the following YAML.

```
apiVersion: kubedb.com/v1alpha2
kind: MySQL
metadata:
  name: mysql-cluster
  namespace: demo
spec:
  replicas: 2
  version: "8.0.29"
  storageType: Durable
  storage:
    storageClassName: "standard"
    accessModes:
    - ReadWriteOnce
    resources:
      requests:
        storage: 1Gi
  terminationPolicy: WipeOut
```

The Operator will create a custom resource `mysql-cluster`. It will also create a statefulset named `mysql-cluster` as well. The statefulset will eventually create two pods named `mysql-cluster-0` and `mysql-cluster-1`.

### Create a custom docker image with required configurations

At first, create a filebeat.yml file with your required configurations. Let's assume that you want to read DB logs from a mysql container. In kubeDB managed MySQL pod, the log file is mounted in `/var/lib/mysql` directory in `{pod-name}.log` file.

The following example configures Filebeat to harvest lines from all log files that match the specified glob patterns. For this demo, we are going to Forward the output to console. The Console output writes events in JSON format to stdout.

```
filebeat.inputs:
  - type: log
    paths:
    - /var/lib/mysql/*.log
output.console:
  pretty: true
```

You can also provide specific log file paths for specific pods as well. Use the following command to view all the log files available in `mysql-cluster-0` pod.

```
$ kubectl exec -it mysql-cluster-0 -n demo -c mysql -- bash -c "cd /var/lib/mysql && ls | grep *.log"

mysql-quickstart-0.log
```

Now create a Dockerfile in the same directory. The use your base filebeat image as your requirement. For this demo, we are using `Filebeat 7.17.1`. In the Dockerfile, copy the filebeat.yml to default filebeat.yml directory to override the existing one.

```
FROM elastic/filebeat:7.17.1
COPY filebeat.yml /usr/share/filebeat
USER root
RUN chmod go-w /usr/share/filebeat/filebeat.yml
USER filebeat
```

The working directory should be structured like this:
```
.
├── Dockerfile
└── filebeat.yml
```

Now, Use the following command to create the docker image and push to your remote dockerhub repository.

```
docker build -t repository_name/custom_filebeat:latest .
docker push repository_name/custom_filebeat:latest
```
### Patch the custom Filebeat docker image configuration in the Operator generated StatefulSet

You can view the operator generated statefulset via the folllowing command.

```
kubectl get sts mysql-cluster -n demo -oyaml
```

In order to add your custom container using the `custom_filebeat` image, create a YAML file named `mysql-patch.yaml` using the following spec. The log file is mounted in a shared PVC directory. Set the `securityContext.runAsUser` to MySQL user ID so that the mysql owned log files can be read by filebeat.

```
spec:
  template:
    spec:
      containers:
      - image: repository_name/custom_filebeat:latest
        name: filebeat
        volumeMounts:
        - mountPath: /var/lib/mysql
          name: data
          readOnly: true
      securityContext:
        runAsUser: 999
```

Patch this YAML to our existing statefulset using the following command.

```
kubectl patch sts mysql-cluster -n demo --patch-file mysql-patch.yaml
```

Get the `mysql-cluster` statefulset YAML to confirm that the changes has been patched. Now, make a `MySQLOpsRequest` of type Restart to restart the Pods with the newly applied configurations. Apply the following YAML to make an OpsRequest to your `mysql-cluster` custom resource.

### Restart the pods with updated configurations

```
apiVersion: ops.kubedb.com/v1alpha1
kind: MySQLOpsRequest
metadata:
  name: mysql-cluster-restart
  namespace: demo
spec:
  type: Restart
  databaseRef:
    name: mysql-cluster
```

After the OpsRequest being successfull, the pods will be restarted with newly applied configurations. You can now exec into the `mysql` container and enable general_log using the following commands.

```
kubectl logs -f -n demo pod/mysql-cluster-0 -c exec
mysql -uroot -p$MYSQL_ROOT_PASSWORD
mysql> set global general_log=ON;
```

Now, View the `filebeat` container logs from another terminal to see the logs generated by mysql queries. You can continuously make queries in the terminal where the mysql container is executed and observe the query logs generated in the terminal where filebeat container is executed.

```
kubectl logs -f -n demo pod/mysql-cluster-0 -c filebeat
```

You can configure the `filebeat.yml` file to forward the output to [`Elasticsearch`](https://www.elastic.co/guide/en/beats/filebeat/current/elasticsearch-output.html) , [`Logstash`](https://www.elastic.co/guide/en/beats/filebeat/current/elasticsearch-output.html) , [`Kafka`](https://www.elastic.co/guide/en/beats/filebeat/current/kafka-output.html), [`redis`](https://www.elastic.co/guide/en/beats/filebeat/current/redis-output.html) etc. instead of console stdout.

## Support

To speak with us, please leave a message on [our website](https://appscode.com/contact/).

To join public discussions with the KubeDB community, join us in the [Kubernetes Slack team](https://kubernetes.slack.com/messages/C8149MREV/) channel `#kubedb`. To sign up, use our [Slack inviter](http://slack.kubernetes.io/).

To receive product announcements, follow us on [Twitter](https://twitter.com/KubeDB).

If you have found a bug with KubeDB or want to request for new features, please [file an issue](https://github.com/kubedb/project/issues/new).
